VERSION 1.0 CLASS
BEGIN
  MultiUse = -1  'True
END
Attribute VB_Name = "RecordSource"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = False
Attribute VB_Exposed = True
Option Compare Database
Option Explicit

Dim cnt As New ADODB.Connection, rst As New ADODB.Recordset 'http://bit.ly/2uc7yGe
Dim whereClause As New WhereClauses, fldShow As String ', frm As Form ', f As adodb.Field ', i As Byte 'fld：field
Dim excel_layout As New ExcelLayout
    
Enum excelFields_RecordSource ' excel 原檔（資料來源 record source）欄位順序，記下以備用
    流水號 = 1
    書名 = 2
    頁碼 = 3
    作者 = 4
    詞牌 = 5
    首句 = 6
    韻法 = 7
    調式 = 8
    字數 = 9
    韻字 = 10
    協韻方式 = 11
    入聲韻 = 12
    聲調 = 13
    韻部 = 14
    韻數 = 15
    備註 = 16
    已發現錯誤 = 17
    舊序號 = 18
End Enum

Property Get fFullName() As String 'Get the current excel file name
Dim flName As String
flName = Forms("歷代詞作韻律資料庫檢索表單").fFullName.ControlSource
If InStr(flName, ":\") Then
    fFullName = flName
Else
    fFullName = CurrentProject.Path & "\" & flName   'CurrentProject.Path & "\@@詞學韻律資料庫設計用20170721.xlsm
End If
If InStrRev(fFullName, ".") = 0 Then fFullName = fFullName & ".xlsm"   '如果沒有副檔名
If Dir(fFullName) = "" Then
    MsgBox "找不到來源來檔" & vbCr & vbCr & "**詞學韻律資料庫**.xlsm", vbExclamation
    End
End If
End Property

Function connetRecordSourceValuesArray(fldName As String, v() As String, AndOr_TrueisAnd As Boolean) 'fldname=field's name '單一欄位多個值
    
    On Error GoTo errh:
'    cnt.Open "Provider=Microsoft.ACE.OLEDB.12.0;" & _
                "Data Source=" & fFullName & ";" & _
                    "Extended Properties=""Excel 8.0;HDR=Yes;"";" '如今 要用「Microsoft.ACE.OLEDB.12.0」取代「Microsoft.Jet.OLEDB.4.0」才能取得完整的記錄錄集（recordset）
    Select Case fldName
        Case "調式", "作者", "韻字"
            fldShow = "流水號,書名,頁碼,作者,詞牌,首句,調式,字數,韻字,韻數"
    
        Case Else
            fldShow = "*" 'rst.Open "select * from [工作表1$] " ...
    End Select
    rst.Open "select " & fldShow & " from [工作表1$] " & whereClause.WhereCl_1FarrayV(fldName, v, AndOr_TrueisAnd), cnt, adOpenKeyset, adLockOptimistic, 1
    
    excel_layout.FieldNameRow_FreezeWindow rst

    rst.Close:    cnt.Close
    Set rst = Nothing:    Set cnt = Nothing
Exit Function


errh:
    Select Case Err.Number
        Case Else
            MsgBox Err.Number & Err.Description
'            Resume
'        End
    End Select
End Function

Function connetRecordSourceResult(fldName() As String, v() As String, AndOr_TrueisAnd As Boolean) 'fldname=field's name '單一欄位多個值
    
    On Error GoTo errh:
'    cnt.Open "Provider=Microsoft.ACE.OLEDB.12.0;" & _
                "Data Source=" & fFullName & ";" & _
                    "Extended Properties=""Excel 8.0;HDR=Yes;"";" '如今 要用「Microsoft.ACE.OLEDB.12.0」取代「Microsoft.Jet.OLEDB.4.0」才能取得完整的記錄錄集（recordset）
    
    fldShow = "流水號,書名,頁碼,作者,詞牌,首句,調式,字數,韻字,韻數"
    
    rst.Open "select " & fldShow & " from [工作表1$] " & whereClause.WhereCl_MultFldVals_Instr(fldName, v, AndOr_TrueisAnd), cnt, adOpenKeyset, adLockOptimistic, 1
    
    excel_layout.FieldNameRow_FreezeWindow rst

    rst.Close:    cnt.Close
    Set rst = Nothing:    Set cnt = Nothing
Exit Function


errh:
    Select Case Err.Number
        Case Else
            MsgBox Err.Number & Err.Description
'            Resume
'        End
    End Select
End Function


Function connetRecordSource_WhereClause(whereClause) ' where 子句（條件句）作參數
    
    On Error GoTo errh:
    fldShow = "流水號,書名,頁碼,作者,詞牌,首句,調式,字數,韻字,韻數"

    rst.Open "select " & fldShow & " from [工作表1$] " & whereClause, cnt, adOpenKeyset, adLockOptimistic, 1
    
    excel_layout.FieldNameRow_FreezeWindow rst

    rst.Close:    cnt.Close
    Set rst = Nothing:    Set cnt = Nothing
Exit Function


errh:
    Select Case Err.Number
        Case Else
            MsgBox Err.Number & Err.Description
'            Resume
'        End
    End Select
End Function

Private Sub Class_Initialize()
    cnt.Open "Provider=Microsoft.ACE.OLEDB.12.0;" & _
                "Data Source=" & fFullName & ";" & _
                    "Extended Properties=""Excel 8.0;HDR=Yes;"";" '如今 要用「Microsoft.ACE.OLEDB.12.0」取代「Microsoft.Jet.OLEDB.4.0」才能取得完整的記錄錄集（recordset）

End Sub
